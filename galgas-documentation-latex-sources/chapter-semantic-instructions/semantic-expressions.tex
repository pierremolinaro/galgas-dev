%!TEX encoding = UTF-8 Unicode
%!TEX root = ../galgas-book.tex

%--------------------------------------------------------------
\chapter{Expressions}
%-------------------------------------------------------------

D'une manière classique, une expression est constituée d'\emph{opérandes} (\refSectionPage{operandesDansExpression}) et d'\emph{opérateurs} (\refSectionPage{operateursDansExpression}). La priorité des opérateurs est définie dans le \refTableauPage{prioriteOperateurs}.



%-------------------------------------------------------------

\sectionLabel{Opérandes}{operandesDansExpression}

\subsection{Identificateur}

\subsection{\texttt{selfcopy}}\index{selfcopy}

\galgas{selfcopy} représente une copie de l'objet courant. On ne peut donc utiliser \galgas{selfcopy} que dans une expression à l'intérieur d'une \emph{méthode}, d'un \emph{reader}, d'un \emph{modifier}, ou d'une extension (\refChapterPage{extensions}). Sont donc exclues les routines et les fonctions.

\galgas{selfcopy} effectue un accès en lecture seule de l'objet courant. 

Voici un exemple extrait de la section décrivant les \emph{reader catégorie} (\refSectionPage{categoryReader}) :
\begin{lstlisting}[language=galgas]
reader @uint64 square -> @uint64 outResult :
  outResult := selfcopy * selfcopy ;
end reader ;
\end{lstlisting}








\subsectionLabel{Expression de conversion polymorphique inverse}{expConversionPolymorphiqueInverse}

\lstset{emph={expression, conversion}, emphstyle=\emph}

La syntaxe de l'\emph{expression de conversion polymorphique inverse} est : \galgas{(cast expression : @T)}. Les parenthèses sont obligatoires. Elle permet de renvoyer la valeur de \galgas{expression} sous la forme d'un objet de type statique \galgas{@T}. À l'exécution, la conversion échoue si le type dynamique de l'\galgas{expression} n'est pas \galgas{@T} ou une de ses classes héritières ; une erreur sémantique est alors déclenchée, et l'expression renvoie un objet \emph{non construit}.

Pour tester le type dynamique de l'expression avant d'effectuer la conversion, utiliser la construction décrite à la \refSubsectionPage{testTypeDynamiqueExpression}. On peut aussi utiliser l'instruction \galgas{cast} (\refSectionPage{instructionCast}).







\subsectionLabel{Test du type dynamique d'une expression}{testTypeDynamiqueExpression}

L'opérande \galgas{(expression is conversion @T)} (les parenthèses sont obligatoires) teste le type dynamique de \galgas{expression} vis à vis du type \galgas{@T} :
\begin{itemize}
\item si \galgas{conversion} est \galgas{==}, la valeur renvoyée est \galgas{true} si le type dynamique de l'\galgas{expression} est exactement \galgas{@T}, et \galgas{false} dans le cas contraire ;
\item si \galgas{conversion} est \galgas{>=}, la valeur renvoyée est \galgas{true} si le type dynamique de l'\galgas{expression} est \galgas{@T} ou une de ses classes héritières, et \galgas{false} dans le cas contraire ;
\item si \galgas{conversion} est \galgas{>}, la valeur renvoyée est \galgas{true} si le type dynamique de l'\galgas{expression} n'est pas \galgas{@T} mais une de ses classes héritières, et \galgas{false} dans le cas contraire.
\end{itemize}


.

Alliée à la construction précédente, elle permet de lancer une conversion uniquement si elle est possible :

\begin{galgascode}
if (expression is == @B) then
  @B var := (cast expression : @T) ;
  ...
elsif (expression is >= @C) then
  @C var := (cast expression : @C) ;
  ...
else
  message "conversion impossible" ;
end if ;
\end{galgascode}

\subsection{Parenthèses}

Les parenthèses \galgas{(} et \galgas{)} permettent de forcer le groupement d'opérandes.

\subsection{\texttt{true} et \texttt{false}}

\galgas{true} et \galgas{false} sont les constantes du type \galgas{@bool}.

\subsection{\texttt{here}}

\galgas{here} est une constante de type \galgas{@location}. Elle a pour valeur la position courante de la lecture du fichier source.

\subsection{Constante Chaîne de caractères}

\subsection{Constante caractère}

\subsection{Constante entière}

Une constante entière est une séquence de chiffres décimaux, éventuellement séparés par le caractère de soulignement \galgas{_}, et terminé par un suffixe. Ce suffixe détermine le type de la constante :
\begin{itemize}
  \item pas de suffixe : \galgas{@uint} ;
  \item suffixe \galgas{S} : \galgas{@sint} ;
  \item suffixe \galgas{L} : \galgas{@uint64} ;
  \item suffixe \galgas{LS} : \galgas{@sint64}.
\end{itemize}

\subsection{Constante flottante}

\subsection{Expression \texttt{if}}

\subsectionLabel{Appel de fonction}{appelFonction}

\subsectionLabel{Appel de reader}{appelReader}


\subsection{Appel de constructeur}



\subsection{Constructeur par défaut}

L'expression \galgas{[@T default]} invoque le constructeur par défaut du type \galgas{@T} et renvoie un objet initialisé du type \galgas{@T}.

Pour la plupart des types, un constructeur par défaut est implicitement défini (voir le détail \refSectionPage{constructeurParDefaut}).




\subsectionLabel{Valeur d'une option}{appelOption}

Les options de la ligne de commande sont définies dans un composant \galgas{option} (\refChapterPage{composantOption}). L'opérande \emph{appel d'option} permet d'obtenir des informations sur une option.

\lstset{emph={nom_composant_option, nom_option, nom_info}, emphstyle=\emph}
Sa syntaxe est \galgas{[option nom_composant_option.nom_option nom_info]}, où :
\begin{itemize}
  \item \galgas{nom_composant_option} est le nom du composant \galgas{option} qui déclare l'option ;
  \item \galgas{nom_option} est le nom donné à l'option lors de sa déclaration ;
  \item \galgas{nom_info} est le nom de l'information dont la valeur sera retournée par l'opérande.
\end{itemize}


Les informations qui peuvent être ainsi obtenues sont décrites dans le \refTableau{infosDeAppelOption}.
\begin{table}[!ht]
  \centering
  \begin{tabular}{llll}
  \textbf{nom\_info} & \textbf{Commentaire}  & \textbf{Type de la valeur retournée}\\
  \hline
  \galgas{value} & Valeur de l'option & \galgas{@T} (le type de l'option)\\
  \galgas{char} & Caractère d'appel de l'option & \galgas{@char}\\
  \galgas{string} & Chaîne d'appel de l'option & \galgas{@string}\\
  \galgas{comment} & Description de l'option & \galgas{@string}\\
  \hline
  \end{tabular}
  \caption{Informations relatives à une option de la ligne de commande}
  \labelTableau{infosDeAppelOption}
\end{table}

Par exemple, si un composant \galgas{option} est déclaré comme suit :
\begin{galgascode}
option mesOptions :
  @bool extractOption : 'S', "asm" -> "Extract assembly code" ;
end  option ;
\end{galgascode}

Alors :
\begin{itemize}
  \item \galgas{[option mesOptions.extractOption value]} renvoie un \galgas{@bool} qui vaut \galgas{true} si l'option a été activée, \galgas{false} dans le cas contraire ;
  \item \galgas{[option mesOptions.extractOption char]} renvoie un \galgas{@char} qui vaut \galgas{'S'} ;
  \item \galgas{[option mesOptions.extractOption string]} renvoie un \galgas{@string} qui vaut \galgas{"asm"} ;
  \item \galgas{[option mesOptions.extractOption comment]} renvoie un \galgas{@string} qui vaut \galgas{"Extract assembly code"}.
\end{itemize}





%-------------------------------------------------------------------

\sectionLabel{Opérateurs}{operateursDansExpression}

\subsectionLabel{Priorité des opérateurs}{prioriteOperateurs}

La priorité des opérateurs est définie dans le \refTableau{prioriteOperateurs}. Pour des opérateurs de même priorité, le groupement s'effectue de gauche à droite. Les parenthèses permettent de forcer l'ordre d'évaluation. Par exemple, \galgas{4 + 3 - 2 - 3} est équivalent à \galgas{((4 + 3) - 2) - 3}.

\begin{table}[!ht]
  \centering
%  \rowcolors{2}{\fondTableau}{}
  \begin{tabular}{llll}
  \textbf{Priorité} & \textbf{Opérateur}  & \textbf{Commentaire} & \textbf{Référence}\\
  \hline
  0 (plus faible) & \galgas{.} & Concaténation & \refSubsectionPage{operateurConcatenation}\\
  1 & \galgas{\|} & « ou » logique & \refSubsectionPage{operateursLogiques}\\
    & \galgas{\^} & « ou exclusif » logique & \refSubsectionPage{operateursLogiques}\\
  2 & \galgas{\&} & « et » logique & \refSubsectionPage{operateursLogiques}\\
  3 & \galgas{==}, \galgas{\!=} & Comparaison & \refSubsectionPage{operateursComparaison}\\
    & \galgas{<}, \galgas{<=} & Comparaison & \refSubsectionPage{operateursComparaison}\\
    & \galgas{>}, \galgas{>=} & Comparaison & \refSubsectionPage{operateursComparaison}\\
  4 & \galgas{<<}, \galgas{>>} & Décalage & \refSubsectionPage{operateursDecalage}\\
    & \galgas{+} & Addition & \refSubsectionPage{operateursArithmétique}\\
    & \galgas{-} & Soustraction & \refSubsectionPage{operateursArithmétique}\\
  5 & \galgas{*} & Multiplication & \refSubsectionPage{operateursArithmétique}\\
    & \galgas{/} & Division & \refSubsectionPage{operateursArithmétique}\\
    & \galgas{mod} & Modulo & \refSubsectionPage{operateursArithmétique}\\
  6 & \galgas{-} & Négation arithmétique & \refSubsectionPage{operateursArithmétique}\\
  7 & \galgas{not} & Complémentation booléenne & \refSubsectionPage{operateursLogiques}\\
  8 & \galgas{\~} & Complémentation bit-à-bit & \refSubsectionPage{complementationBitABit}\\
  9 (plus forte) & \galgas{->} & Accès à un champ d'une structure & \refSubsectionPage{accesChampStructure}\\
  \hline
  \end{tabular}
  \caption{Priorité des opérateurs}
  \labelTableau{prioriteOperateurs}
\end{table}

\subsectionLabel{Concaténation}{operateurConcatenation}

\galgas{.}

\subsectionLabel{Logique}{operateursLogiques}

\galgas{\|}, \galgas{\^}, \galgas{\&}, \galgas{not}

\subsectionLabel{Complémentation bit-à-bit}{complementationBitABit}

 \galgas{\~}
 
 
\subsectionLabel{Comparaison}{operateursComparaison}


\subsectionLabel{Décalage}{operateursDecalage}

\galgas{<<} et \galgas{>>}

\subsectionLabel{Arithmétique}{operateursArithmétique}

\galgas{+}, \galgas{-}, \galgas{*}, \galgas{/}, \galgas{mod}.

\galgas{-} unaire.


\subsectionLabel{Accès à un champ d'une structure}{accesChampStructure}

\galgas{->}


