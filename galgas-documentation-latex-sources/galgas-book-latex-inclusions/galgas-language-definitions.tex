%!TEX encoding = UTF-8 Unicode
%!TEX root = ../galgas-book.tex

%-----------------------------------------------------------------------------------------------------------------------*
%   A F F I C H A G E    D U    C O D E    G A L G A S                                                                  *
%-----------------------------------------------------------------------------------------------------------------------*

\usepackage{mdframed}

\newcommand\keywordsStyle[1]{\textcolor{blue}{\textbf{#1}}}
\newcommand\delimitersStyle[1]{\textcolor{brown}{\textbf{#1}}}
\newcommand\selectorStyle[1]{\textcolor{orange}{#1}}
\newcommand\terminalStyle[1]{\textcolor{orange}{#1}}
\newcommand\nonTerminalStyle[1]{\textcolor{orange}{#1}}
\newcommand\integerStyle[1]{\textcolor{brown}{#1}}
\newcommand\floatStyle[1]{\textcolor{magenta}{#1}}
\newcommand\characterStyle[1]{\textcolor{cyan}{#1}}
\newcommand\stringStyle[1]{\textcolor{gray}{#1}}
\newcommand\typeNameStyle[1]{\textcolor{gray}{#1}}
\newcommand\attributeStyle[1]{\textcolor{pink}{#1}}
\newcommand\commentStyle[1]{\textcolor{red}{#1}}

\newmdenv[
  topline=false,
  bottomline=false,
  rightline=false,
  skipabove=\topsep,
  skipbelow=\topsep,
  linecolor=blue!25,
  linewidth=2pt
]{siderules}

\newwrite\tempfile

\makeatletter
\newenvironment{galgascode}{%
  \begingroup
  \@bsphack
  \immediate\openout\tempfile=temp.galgas%
  \let\do\@makeother\dospecials
  \catcode`\^^M\active
  \verbatim@startline
  \verbatim@addtoline
  \verbatim@finish
  \def\verbatim@processline{\immediate\write\tempfile{\the\verbatim@line}}%
  \verbatim@start
}{
  \immediate\closeout\tempfile
  \@esphack
  \endgroup
  \immediate\write18{galgas --mode=latex temp.galgas}
  \begin{siderules}
    \ttfamily\input{temp.galgas.tex}
  \end{siderules}
}
\makeatother

%-----------------------------------------------------------------------------------------------------------------------*
% COMMANDE \ggs : affichage de code en ligne galgas                                                                     *
%-----------------------------------------------------------------------------------------------------------------------*

\makeatletter
\newcommand*\ggs{%
  \@bsphack%
  \begingroup%
  \let\do\@makeother\dospecials%
  \let\do\do@noligs\verbatim@nolig@list%
  \catcode`\^^M=15\relax%
  \@vobeyspaces%
  \@ggs{\temporary}%
}%
\newcommand\@ggs[2]{%
  \catcode`-=12\relax%
  \catcode`<=12\relax%
  \catcode`>=12\relax%
  \catcode`,=12\relax%
  \catcode`'=12\relax%
  \catcode``=12\relax%
  \catcode`#2\active%
  \catcode`~\active%
  \lccode`\~`#2\relax%
  \lowercase{%
    \begingroup%
    \def\@tempa##1~{%
      \edef\@tempa{%
        \noexpand\@ifstar{%
          \noexpand\@@ggs\noexpand\visiblespaces{##1}%
        }{%
          \noexpand\@@ggs\noexpand\whitespaces{##1}%
        }%
      }%
      \expandafter\endgroup%
      \expandafter\DeclareRobustCommand%
      \expandafter*%
      \expandafter#1%
      \expandafter{%
      \@tempa}%
      \@esphack%
      \immediate\openout\tempfile=temp.galgas%
      \immediate\write\tempfile{##1}%
      \immediate\closeout\tempfile%
      \immediate\write18{galgas --mode=latex temp.galgas}\texttt{\input{temp.galgas.tex}\unskip}%
    }%
  }%
  \ifnum`#2=`\~\else\@makeother\~\fi%
  \expandafter\endgroup%
  \@tempa%
}%
\newcommand*\@@ggs[2]{%
  \relax\ifmmode\hbox\else\leavevmode\null\fi%
  \bgroup#1\frenchspacing\verbatim@font\verbtextstyle#2\egroup%
}%
\let\verbtextstyle\relax%
\newcommand*\visiblespaces{\chardef\ 32\relax}%
\newcommand*\whitespaces{\let\ \@@space}%
\let\@@space\ %
\makeatother

%-----------------------------------------------------------------------------------------------------------------------*
%                                                                                                                       *
% A F F I C H A G E    E T    C R O S S   R É F É R E N C E    D E S    T Y P E S    P R É D É F I N I S   G A L G A S  *
%                                                                                                                       *
%-----------------------------------------------------------------------------------------------------------------------*

%--- Les deux macros suivantes définissent une section et une sous-section :
%      - en formattant le titre
%      - en définissant un label pour cross référence ;
%      - en définissant une entrée dans l'index

% Exemple d'appel : \sectionTypePredefiniLabelIndex{bool}

\newcommand \chapitreTypePredefiniLabelIndex[1] {\chapter{Le type \texttt{@#1}}\label{type:#1}\index{Type!"@#1}}

\newcommand \sectionTypePredefiniLabelIndex[1] {\section{Le type \texttt{@#1}}\label{type:#1}\index{Type!"@#1}}

\newcommand \subsectionTypePredefiniLabelIndex[1] {\subsection{Le type \texttt{@#1}}\label{type:#1}\index{Type!"@#1}}

%--- Cette macro établit un hyperlien vers un type prédéfini
% Exemple d'appel : \refTypePredefini{bool} -- affiche --> @bool type (page xx)

\newcommand \refTypePredefini[1] {\hyperref[type:#1]{\texttt{@#1} (page \pageref{type:#1})}}

%-----------------------------------------------------------------------------------------------------------------------*
%   G E T T E R   C R O S S    R E F E R E N C I N G                                                                    *
%-----------------------------------------------------------------------------------------------------------------------*

\newcommand\subsectionGetter[2]{\subsection{Getter \texttt{#1}}\label{getter:#2:#1}\index{#1!"@#2 getter}}

%-----------------------------------------------------------------------------------------------------------------------*

% Exemple d'appel : \refGetterPage{bool}{string} -- affiche --> @bool string getter (page xx)
\newcommand\refGetterPage[2] {\hyperref[getter:#1:#2]{\texttt{@#1 #2} getter (page \pageref{getter:#1:#2})}}

%-----------------------------------------------------------------------------------------------------------------------*
%   S E T T E R   C R O S S    R E F E R E N C I N G                                                                    *
%-----------------------------------------------------------------------------------------------------------------------*

\newcommand\subsectionSetter[2]{\subsection{Setter \texttt{#1}}\label{setter:#2:#1}\index{#1!"@#2 getter}}

%-----------------------------------------------------------------------------------------------------------------------*

% Exemple d'appel : \refSetterPage{bool}{string} -- affiche --> @bool string setter (page xx)
\newcommand\refSetterPage[2] {\hyperref[setter:#1:#2]{\texttt{@#1 #2} setter (page \pageref{setter:#1:#2})}}


%-----------------------------------------------------------------------------------------------------------------------*
%   C O N S T R U C T O R   C R O S S    R E F E R E N C I N G                                                          *
%-----------------------------------------------------------------------------------------------------------------------*

\newcommand\subsectionConstructor[2]{\subsection{Constructeur \texttt{#1}}\label{constructor:#2:#1}\index{#1!"@#2 constructor}}

%-----------------------------------------------------------------------------------------------------------------------*

\newcommand \refConstructorPage[2] {\hyperref[constructor:#1:#2]{#2 constructor (page \pageref{constructor:#1:#2})}}

%-----------------------------------------------------------------------------------------------------------------------*
