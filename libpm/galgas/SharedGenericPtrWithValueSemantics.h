//--------------------------------------------------------------------------------------------------
//
//  SharedGenericObjectWithValueSemantics.h
//
//  Created by Pierre Molinaro on 15/03/2025, ..., 2025 Pierre Molinaro.
//
//  e-mail : pierre@pcmolinaro.name
//
//  This library is free software; you can redistribute it and/or modify it under the terms of the GNU Lesser General
//  Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option)
//  any later version.
//
//  This program is distributed in the hope it will be useful, but WITHOUT ANY WARRANTY; without even the implied
//  warranty of MERCHANDIBILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
//  more details.
//
//--------------------------------------------------------------------------------------------------

#pragma once

//--------------------------------------------------------------------------------------------------

#include "SharedObject.h"

//--------------------------------------------------------------------------------------------------

template <typename TYPE> class SharedGenericPtrWithValueSemantics ;

//--------------------------------------------------------------------------------------------------
// SharedGenericObjectWithValueSemantics
//--------------------------------------------------------------------------------------------------

template <typename TYPE> class SharedGenericObjectWithValueSemantics final : public SharedObject {

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //  Property
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: TYPE mValue ;

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //  Constructor
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  
  public: SharedGenericObjectWithValueSemantics (const TYPE & inValue
                                                 COMMA_LOCATION_ARGS) :
  SharedObject (THERE),
  mValue (inValue) {
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //  No copy
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  private: SharedGenericObjectWithValueSemantics (const SharedGenericObjectWithValueSemantics &) = delete ;

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //  No assignment
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  private: SharedGenericObjectWithValueSemantics & operator = (const SharedGenericObjectWithValueSemantics &) = delete ;

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //  Default destructor
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: virtual ~ SharedGenericObjectWithValueSemantics (void) = default ;

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //  Clone method
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: SharedGenericObjectWithValueSemantics <TYPE> * cloned (LOCATION_ARGS) const {
    SharedGenericObjectWithValueSemantics <TYPE> * result = nullptr ;
    macroMyNew (result, SharedGenericObjectWithValueSemantics <TYPE> (mValue COMMA_THERE)) ;
    return result ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //  Friend
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

//  template <TYPE> friend class SharedGenericPtrWithValueSemantics ;

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

} ;

//--------------------------------------------------------------------------------------------------
// SharedGenericPtrWithValueSemantics template class
//--------------------------------------------------------------------------------------------------

template <typename TYPE> class SharedGenericPtrWithValueSemantics {

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Private property
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  private: SharedGenericObjectWithValueSemantics <TYPE> * mSharedPtr ;

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Default constructor
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: SharedGenericPtrWithValueSemantics (void) : mSharedPtr (nullptr) { }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Virtual destructor
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: ~ SharedGenericPtrWithValueSemantics (void) {
    macroDetachSharedObject (mSharedPtr) ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Set to nil
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: void setToNil (void) {
    macroDetachSharedObject (mSharedPtr) ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Make
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: template <class... _Args> static SharedGenericPtrWithValueSemantics <TYPE> make (_Args&&... __args) {
    SharedGenericPtrWithValueSemantics <TYPE> result ;
    macroMyNew (result.mSharedPtr, SharedGenericObjectWithValueSemantics <TYPE> (std::forward<_Args>(__args)...)) ;
    return result ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Accessors
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: inline bool isNotNil (void) const { return mSharedPtr != nullptr ; }
  public: inline bool isNil (void) const { return mSharedPtr == nullptr ; }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: TYPE * operator -> (void) {
    macroValidPointer (mSharedPtr) ;
    if (!mSharedPtr->isUniquelyReferenced ()) {
      auto newPtr = mSharedPtr->cloned (HERE) ;
      macroDetachSharedObject (mSharedPtr) ;
      mSharedPtr = newPtr ;
    }
    return &(mSharedPtr->mValue) ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: const TYPE * operator -> (void) const {
    macroValidPointer (mSharedPtr) ;
    return &(mSharedPtr->mValue) ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: const TYPE value (void) const {
    macroValidPointer (mSharedPtr) ;
    return mSharedPtr->mValue ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Copy constructor from SharedGenericPtrWithValueSemantics <TYPE>
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: SharedGenericPtrWithValueSemantics (const SharedGenericPtrWithValueSemantics <TYPE> & inSource) :
  mSharedPtr (nullptr) {
    macroAssignSharedObject (mSharedPtr, inSource.mSharedPtr) ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Assignment from SharedGenericPtrWithValueSemantics <TYPE>
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  public: SharedGenericPtrWithValueSemantics <TYPE> & operator = (const SharedGenericPtrWithValueSemantics <TYPE> & inSource) {
    macroAssignSharedObject (mSharedPtr, inSource.mSharedPtr) ;
    return *this ;
  }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  //   Friends
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  template <typename SOURCE> friend class SharedGenericPtrWithValueSemantics ;

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

} ;

//--------------------------------------------------------------------------------------------------
