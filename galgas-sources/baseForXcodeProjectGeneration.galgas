#  This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public   *
#  License as published by the Free Software Foundation.                                                               *
#                                                                                                                      *
#  This program is distributed in the hope it will be useful, but WITHOUT ANY WARRANTY; without even the implied       *
#  warranty of MERCHANDIBILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more        *
#  details.                                                                                                            *
#----------------------------------------------------------------------------------------------------------------------*



#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    XcodeObjectReferenceList                                                                                          *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

list @XcodeObjectReferenceList {
  @string mRefString
  @string mComment
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXFileReference                                                                                                  *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

abstract class @Xcode_PBXFileReference_abstract {
  @uint mSequenceNumber
  @string mFileName
}

#----------------------------------------------------------------------------------------------------------------------*

abstract method @Xcode_PBXFileReference_abstract buildXcodeProject ?!@string outString

#----------------------------------------------------------------------------------------------------------------------*

private func getPBXFileReferenceKey
  ?seq:let @uint inSequenceNumber
  -> @string outResult {
  outResult = [[[inSequenceNumber string] md5] rightSubString!24]
}

#----------------------------------------------------------------------------------------------------------------------*

abstract class @Xcode_productFileReference : @Xcode_PBXFileReference_abstract {
}

#----------------------------------------------------------------------------------------------------------------------*

abstract method @Xcode_productFileReference productExtension !extension:@string outProductExtension

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_CompiledMachOExecutable : @Xcode_productFileReference {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_CompiledMachOExecutable productExtension !extension:@string outProductExtension {
  outProductExtension = "tool"
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_CompiledMachOExecutable buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " = {isa = PBXFileReference; explicitFileType = \"compiled.mach-o.executable\"; includeInIndex = 0; path = "
  + [mFileName utf8Representation] + "; sourceTree = BUILT_PRODUCTS_DIR; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_Application : @Xcode_productFileReference {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_Application productExtension !extension:@string outProductExtension {
  outProductExtension = "application"
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_Application buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " = {isa = PBXFileReference; explicitFileType = \"compiled.wrapper.application\"; includeInIndex = 0; path = "
  + [mFileName utf8Representation] + "; sourceTree = BUILT_PRODUCTS_DIR; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_cppSourceFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_cppSourceFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_hSourceFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_hSourceFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_pchSourceFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_pchSourceFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.pch; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_mSourceFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_mSourceFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.obj; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_mmSourceFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_mmSourceFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.objcpp; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_gifFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_gifFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; lastKnownFileType = image.gif; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_tiffFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_tiffFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; lastKnownFileType = image.tiff; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_pngFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_pngFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; lastKnownFileType = image.png; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_plistFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_plistFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text.plist; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_frameworkFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_frameworkFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; lastKnownFileType = wrapper.framework; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_icnsFile : @Xcode_PBXFileReference_abstract  {
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_icnsFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; lastKnownFileType = image.icns; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFileName utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_xibFile : @Xcode_PBXFileReference_abstract  {
  @string mFilePath
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_xibFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; lastKnownFileType = wrapper.xib; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFilePath utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFileReference_plistStringFile : @Xcode_PBXFileReference_abstract  {
  @string mFilePath
}

#----------------------------------------------------------------------------------------------------------------------*

override method @Xcode_PBXFileReference_plistStringFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber)
  + " /* " + [mFileName lastPathComponent] + " */ = {isa = PBXFileReference; lastKnownFileType = text.plist.strings; name = "
  + [[mFileName lastPathComponent] utf8Representation] + "; path = "
  + [mFilePath utf8Representation] + "; sourceTree = \"<group>\"; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

map @Xcode_PBXFileReference_map {
  @Xcode_PBXFileReference_abstract mFileReference

  insert insertKey error message "the '%K' reference has been already declared in %L"
  search searchKey error message "the '%K' reference is not declared"
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXBuildFile                                                           *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXBuildFile {
  @uint mSequenceNumber
  @Xcode_PBXFileReference_abstract mSourceFile
}

#----------------------------------------------------------------------------------------------------------------------*

method @Xcode_PBXBuildFile buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber) + " /* " + [mSourceFile mFileName] + " */ "
  + "= {isa = PBXBuildFile; fileRef = " + getPBXFileReferenceKey (!seq:[mSourceFile mSequenceNumber])
  + " ; settings = {ATTRIBUTES = (); }; };\n"
}

#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_PBXBuildFile_list {
  @Xcode_PBXBuildFile mFile
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXSourcesBuildPhase                                                                                              *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXSourcesBuildPhase {
  @uint mSequenceNumber
  @string mNameForComment
  @Xcode_PBXBuildFile_list mFileReferenceList
}

#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_PBXSourcesBuildPhase_list {
  @Xcode_PBXSourcesBuildPhase mBuildPhase
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXResourcesBuildPhase                                                                                            *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXResourcesBuildPhase {
  @uint mSequenceNumber
  @string mNameForComment
  @Xcode_PBXBuildFile_list mFileReferenceList
}

#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_PBXResourcesBuildPhase_list {
  @Xcode_PBXResourcesBuildPhase mBuildPhase
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXCopyBuildPhase                                                                                                 *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXCopyBuildPhase {
  @uint mSequenceNumber
  @string mNameForComment
  @uint mDestinationSubfolder
  @string mDestinationPath
  @Xcode_PBXBuildFile_list mFileReferenceList
}

#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_PBXCopyBuildPhase_list {
  @Xcode_PBXCopyBuildPhase mBuildPhase
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXFrameworksBuildPhase                                                                                           *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXFrameworksBuildPhase {
  @uint mSequenceNumber
  @string mNameForComment
  @Xcode_PBXBuildFile_list mFileReferenceList
}

#----------------------------------------------------------------------------------------------------------------------*

method @Xcode_PBXFrameworksBuildPhase buildXcodeProject ?!@string outString {
  outString += "\t\t" + getPBXFileReferenceKey (!seq:mSequenceNumber) + " /* Frameworks */ = {\n"
  + "\t\t\tisa = PBXFrameworksBuildPhase;\n"
  + "\t\t\tbuildActionMask = 2147483647;\n"
  + "\t\t\tfiles = (\n"
  for () in mFileReferenceList do
    outString += "\t\t\t\t" + getPBXFileReferenceKey (!seq:[mFile mSequenceNumber]) + " /* "
    + [[mFile mSourceFile] mFileName] + " */,\n"
  end
  outString += "\t\t\t);\n"
  + "\t\t\trunOnlyForDeploymentPostprocessing = 0;\n"
  + "\t\t};\n"
}

#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_PBXFrameworksBuildPhase_list {
  @Xcode_PBXFrameworksBuildPhase mBuildPhase
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXGroup                                                                                                          *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_PBXGroup {
  @uint mSequenceNumber
  @string mGroupName
  @string mGroupPath
  @XcodeObjectReferenceList mChildrenGroupList
}

#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_PBXGroup_list {
  @Xcode_PBXGroup mGroup
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    XCBuildConfiguration                                                                                              *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_XCBuildConfiguration {
  @uint mSequenceNumber1
  @uint mSequenceNumber2
  @stringlist mSettings
}

#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_XCBuildConfiguration_list {
  @Xcode_XCBuildConfiguration mBuildConfig
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXNativeTarget                                                                                                   *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_PBXNativeTarget_list {
  @string mTargetKey
  @string mTargetName
  @Xcode_XCBuildConfiguration mTargetConfiguration
  @string mProductInstallPath
  @string mProductName
  @Xcode_productFileReference mProduct
  @stringlist mBuildPhaseKeyList
  @stringlist mDependencyKeyList
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXTargetDependency and PBXContainerItemProxy                                                                     *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

class @Xcode_targetDependencyDescription {
  @uint mSequenceNumber
  @string mDependencyTarget
}

#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_targetDependencyDescription_list {
  @Xcode_targetDependencyDescription mDependency
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    PBXVariantGroup                                                                                                   *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

list @Xcode_PBXVariantGroup_list {
  @string mPBXVariantKey
  @string mPBXFileReferenceKey
  @string mName
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    Project Description                                                                                               *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

struct @XcodeProjectDescription {
  @Xcode_PBXFileReference_map mFileReferenceMap
  @Xcode_PBXBuildFile_list mAllBuildFileList
  @XcodeObjectReferenceList mMainGroupChildrenList
  @Xcode_PBXGroup_list mProjectGroupList
  @Xcode_PBXNativeTarget_list mTargetList
  @XcodeObjectReferenceList mProductGroupChildrenList
  @Xcode_XCBuildConfiguration_list mBuildConfigurationList
  @Xcode_PBXSourcesBuildPhase_list mPBXSourcesBuildPhase_list
  @Xcode_PBXFrameworksBuildPhase_list mPBXFrameworksBuildPhase_list
  @Xcode_PBXResourcesBuildPhase_list mPBXResourcesBuildPhase_list
  @Xcode_PBXCopyBuildPhase_list mPBXCopyBuildPhase_list
  @Xcode_targetDependencyDescription_list mDependencyList
  @Xcode_PBXVariantGroup_list mPBXVariantGroup_list
  @uint mSequenceNumber
}

#----------------------------------------------------------------------------------------------------------------------*

proc initXcodeProjectDescription !@XcodeProjectDescription outDescription {
  outDescription = @XcodeProjectDescription.new {
    !@Xcode_PBXFileReference_map. emptyMap
    !@Xcode_PBXBuildFile_list. emptyList
    !@XcodeObjectReferenceList.  emptyList
    !@Xcode_PBXGroup_list. emptyList
    !@Xcode_PBXNativeTarget_list. emptyList
    !@XcodeObjectReferenceList. emptyList
    !@Xcode_XCBuildConfiguration_list. emptyList
    !@Xcode_PBXSourcesBuildPhase_list. emptyList
    !@Xcode_PBXFrameworksBuildPhase_list. emptyList
    !@Xcode_PBXResourcesBuildPhase_list. emptyList
    !@Xcode_PBXCopyBuildPhase_list. emptyList
    !@Xcode_targetDependencyDescription_list. emptyList
    !@Xcode_PBXVariantGroup_list. emptyList
    !0}
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    Group                                                                                                             *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

proc enter_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inGroupName
  ?let @string inGroupPath
  ?let @XcodeObjectReferenceList inGroupContentsKeyList {
  var group =@Xcode_PBXGroup.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    !inGroupName
    !inGroupPath
    !inGroupContentsKeyList
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mProjectGroupList += !group
  ioXcodeProjectDescription.mMainGroupChildrenList += !getPBXFileReferenceKey (!seq:[group mSequenceNumber]) !inGroupName
}

#----------------------------------------------------------------------------------------------------------------------*
#                                                                                                                      *
#    Sub group                                                                                                         *
#                                                                                                                      *
#----------------------------------------------------------------------------------------------------------------------*

proc enter_subgroup
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inSubGroupName
  ?let @string inSubGroupPath
  ?let @XcodeObjectReferenceList inSubGroupContentsKeyList
  ?!@XcodeObjectReferenceList ioSuperGroupContentsKeyList {
  var group =@Xcode_PBXGroup.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    !inSubGroupName
    !inSubGroupPath
    !inSubGroupContentsKeyList
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mProjectGroupList += !group
  ioSuperGroupContentsKeyList += !getPBXFileReferenceKey (!seq:[group mSequenceNumber]) !inSubGroupName
}

#----------------------------------------------------------------------------------------------------------------------*

proc append_cpp_h_files ?!@stringlist ioList ?@string inBaseName {
  ioList += !inBaseName + ".cpp"
  ioList += !inBaseName + ".h"
}

#----------------------------------------------------------------------------------------------------------------------*

proc append_m_h_files ?!@stringlist ioList ?@string inBaseName {
  ioList += !inBaseName + ".m"
  ioList += !inBaseName + ".h"
}

#----------------------------------------------------------------------------------------------------------------------*

proc append_mm_h_files ?!@stringlist ioList ?@string inBaseName {
  ioList += !inBaseName + ".mm"
  ioList += !inBaseName + ".h"
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_cpp_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_cppSourceFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_h_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_hSourceFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_pch_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_pchSourceFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_m_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_mSourceFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_mm_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_mmSourceFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_gif_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inFile !@location.here}
  var ref =@Xcode_PBXFileReference_gifFile.new{![ioXcodeProjectDescription mSequenceNumber] !inFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_tiff_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_tiffFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_png_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_pngFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_plist_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_plistFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_framework_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_frameworkFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_icns_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inCppFile
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var key =@lstring.new{!inCppFile !@location.here}
  var ref =@Xcode_PBXFileReference_icnsFile.new{![ioXcodeProjectDescription mSequenceNumber] !inCppFile}
  ioXcodeProjectDescription.mSequenceNumber ++
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  ioFileListForGroup += !getPBXFileReferenceKey (!seq:[ref mSequenceNumber]) !inCppFile
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inFileName
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  @string pathExtension = [inFileName pathExtension]
  if pathExtension == "cpp" then
    enter_cpp_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "h" then
    enter_h_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "pch" then
    enter_pch_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "m" then
    enter_m_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "mm" then
    enter_mm_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "tiff" then
    enter_tiff_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "gif" then
    enter_gif_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "png" then
    enter_png_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "xib" then
    enter_xib_file_in_group ( !?ioXcodeProjectDescription !"." !inFileName !?ioFileListForGroup )
  elsif pathExtension == "plist" then
    enter_plist_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "framework" then
    enter_framework_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  elsif pathExtension == "icns" then
    enter_icns_file_in_group ( !?ioXcodeProjectDescription !inFileName !?ioFileListForGroup )
  else
    error @location.here : "cannot enter '" + inFileName + "' file : unknown extension"
  end
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_files_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @stringlist inFileList
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  for () in inFileList do
    enter_file_in_group ( !?ioXcodeProjectDescription !mValue !?ioFileListForGroup )
  end
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_xib_file_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string in_lproj_dir
  ?let @string in_xib_fileName
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var ref =@Xcode_PBXFileReference_xibFile.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    ![in_lproj_dir stringByDeletingPathExtension]
    ! in_lproj_dir + "/" + in_xib_fileName
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  var key =@lstring.new{!in_xib_fileName !@location.here}
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  @string PBXVariantGroupKey = [[[[ioXcodeProjectDescription mSequenceNumber] string] md5] rightSubString!24]
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mPBXVariantGroup_list +=
    !PBXVariantGroupKey
    !getPBXFileReferenceKey (!seq:[ref mSequenceNumber])
    !in_xib_fileName
  ioFileListForGroup += !PBXVariantGroupKey !in_xib_fileName
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_plist_strings_in_group
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string in_lproj_dir
  ?let @string in_plist_string_fileName
  ?!@XcodeObjectReferenceList ioFileListForGroup {
  var ref =@Xcode_PBXFileReference_plistStringFile.new{ 
    ![ioXcodeProjectDescription mSequenceNumber]
    ![in_lproj_dir stringByDeletingPathExtension]
    ! in_lproj_dir + "/" + in_plist_string_fileName
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  var key =@lstring.new{!in_plist_string_fileName !@location.here}
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !key !ref]
  @string PBXVariantGroupKey = [[[[ioXcodeProjectDescription mSequenceNumber] string] md5] rightSubString!24]
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mPBXVariantGroup_list +=
    !PBXVariantGroupKey
    !getPBXFileReferenceKey (!seq:[ref mSequenceNumber])
    !in_plist_string_fileName
  ioFileListForGroup += !PBXVariantGroupKey !in_plist_string_fileName
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_file_for_sources_build_phase
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string in_fileName
  ?!@Xcode_PBXBuildFile_list ioBuildPhaseList {
  var key =@lstring.new{!in_fileName !@location.here}
  @Xcode_PBXFileReference_abstract ref
  [[ioXcodeProjectDescription mFileReferenceMap] searchKey !key ?ref]
  var build_file =@Xcode_PBXBuildFile.new{![ioXcodeProjectDescription mSequenceNumber] !ref}
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mAllBuildFileList += !build_file
  ioBuildPhaseList += !build_file
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_file_list_for_sources_build_phase
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @stringlist in_fileList
  ?!@Xcode_PBXBuildFile_list ioBuildPhaseList {
  for () in in_fileList do
    enter_file_for_sources_build_phase (
      !?ioXcodeProjectDescription
      !mValue
      !?ioBuildPhaseList
    )
  end
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_files_for_resources_build_phase
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @stringlist in_fileList
  ?!@Xcode_PBXBuildFile_list ioBuildPhaseList {
  for () in in_fileList do
    var key =@lstring.new{!mValue !@location.here}
    @Xcode_PBXFileReference_abstract ref
    [[ioXcodeProjectDescription mFileReferenceMap] searchKey !key ?ref]
    var build_file =@Xcode_PBXBuildFile.new{![ioXcodeProjectDescription mSequenceNumber] !ref}
    ioXcodeProjectDescription.mSequenceNumber ++
    ioXcodeProjectDescription.mAllBuildFileList += !build_file
    ioBuildPhaseList += !build_file
  end
}

#----------------------------------------------------------------------------------------------------------------------*

proc enter_files_for_frameworks_build_phase
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @stringlist in_framework_fileList
  ?!@Xcode_PBXBuildFile_list ioBuildPhaseList {
  for () in in_framework_fileList do
    var key =@lstring.new{!mValue !@location.here}
    @Xcode_PBXFileReference_abstract ref
    [[ioXcodeProjectDescription mFileReferenceMap] searchKey !key ?ref]
    var build_file =@Xcode_PBXBuildFile.new{![ioXcodeProjectDescription mSequenceNumber] !ref}
    ioXcodeProjectDescription.mSequenceNumber ++
    ioXcodeProjectDescription.mAllBuildFileList += !build_file
    ioBuildPhaseList += !build_file
  end
}

#----------------------------------------------------------------------------------------------------------------------*

proc add_tool_target
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inProductFileName
  ?let @string inTargetName
  ?@stringlist inTargetSettings
  ?let @string inPrecompiledHeaderPath
  ?let @Xcode_PBXBuildFile_list inSourcesToCompileKeyList
  ?let @Xcode_PBXBuildFile_list inFrameworkKeyList
  ?let @stringlist inDirectDependencyList
  !@string outTargetKey {
  var toolFileReference =@Xcode_PBXFileReference_CompiledMachOExecutable.new{![ioXcodeProjectDescription mSequenceNumber] !inProductFileName}
  ioXcodeProjectDescription.mSequenceNumber ++
  var projectNameKey =@lstring.new{!inProductFileName !@location.here}
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !projectNameKey !toolFileReference]

  ioXcodeProjectDescription.mProductGroupChildrenList  += !getPBXFileReferenceKey (!seq:[toolFileReference mSequenceNumber]) !inTargetName
#--- Source Build Phase
  var compileSourcesBuildPhase =@Xcode_PBXSourcesBuildPhase.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    !"Sources"
    !inSourcesToCompileKeyList
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  var buildPhases =@stringlist.listWithValue{!getPBXFileReferenceKey (!seq:[compileSourcesBuildPhase mSequenceNumber])}
#--- Define Frameworks Build Phase
  if [inFrameworkKeyList length] > 0 then
    var frameworksBuildPhase =@Xcode_PBXFrameworksBuildPhase.new{
      ![ioXcodeProjectDescription mSequenceNumber]
      !"Frameworks"
      !inFrameworkKeyList
    }
    ioXcodeProjectDescription.mSequenceNumber ++
    ioXcodeProjectDescription.mPBXFrameworksBuildPhase_list += !frameworksBuildPhase
    buildPhases += !getPBXFileReferenceKey (!seq:[frameworksBuildPhase mSequenceNumber])
  end

  ioXcodeProjectDescription.mPBXSourcesBuildPhase_list += ! compileSourcesBuildPhase
  if inPrecompiledHeaderPath != "" then
    inTargetSettings  += !"GCC_PRECOMPILE_PREFIX_HEADER = YES;"
    inTargetSettings  += !"GCC_PREFIX_HEADER = \"" + inPrecompiledHeaderPath + "\";"
  end
  inTargetSettings += !"PRODUCT_NAME = \"" + inProductFileName + "\";"
  var toolTargetBuildConfiguration =@Xcode_XCBuildConfiguration.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    ![ioXcodeProjectDescription mSequenceNumber] + 1
    !inTargetSettings
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mBuildConfigurationList += !toolTargetBuildConfiguration
  outTargetKey = [[[[ioXcodeProjectDescription mSequenceNumber] string] md5] rightSubString!24]
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mTargetList +=
    !outTargetKey
    !inTargetName
    !toolTargetBuildConfiguration
    !"$(HOME)/bin"
    !inProductFileName
    !toolFileReference
    !buildPhases
    !inDirectDependencyList
}

#----------------------------------------------------------------------------------------------------------------------*

proc add_app_target
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string inProductFileName
  ?let @string inTargetName
  ?@stringlist inTargetSettings
  ?let @string inPrecompiledHeaderPath
  ?let @string inInfoPListFile
  ?let @Xcode_PBXBuildFile_list inSourcesToCompileKeyList
  ?let @Xcode_PBXBuildFile_list inFrameworksToCompileList
  ?let @Xcode_PBXBuildFile_list inResourcesToCompileList
  ?let @stringlist inDirectDependencyList
  ?let @string inFileToCopyInWrapperLaunchServices
  !@string outTargetKey {
  var buildPhases =@stringlist.emptyList{}
#--- Define Product Application File Reference
  var toolFileReference =@Xcode_PBXFileReference_Application.new{![ioXcodeProjectDescription mSequenceNumber] !inProductFileName}
  ioXcodeProjectDescription.mSequenceNumber ++
  var projectNameKey =@lstring.new{!inProductFileName !@location.here}
  [!?ioXcodeProjectDescription.mFileReferenceMap insertKey !projectNameKey !toolFileReference]
#--- Enter Product Application in "Products" Group
  ioXcodeProjectDescription.mProductGroupChildrenList  += !getPBXFileReferenceKey (!seq:[toolFileReference mSequenceNumber]) !inTargetName
#--- Define Resources Build Phase
  var resourcesBuildPhase =@Xcode_PBXResourcesBuildPhase.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    !"Resources"
    !inResourcesToCompileList
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mPBXResourcesBuildPhase_list += !resourcesBuildPhase
  buildPhases += !getPBXFileReferenceKey (!seq:[resourcesBuildPhase mSequenceNumber])
#--- Define Sources Build Phase
  var compileSourcesBuildPhase =@Xcode_PBXSourcesBuildPhase.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    !"Sources"
    !inSourcesToCompileKeyList
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mPBXSourcesBuildPhase_list += ! compileSourcesBuildPhase
  buildPhases += !getPBXFileReferenceKey (!seq:[compileSourcesBuildPhase mSequenceNumber])
#--- Define Frameworks Build Phase
  var frameworksBuildPhase =@Xcode_PBXFrameworksBuildPhase.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    !"Frameworks"
    !inFrameworksToCompileList
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mPBXFrameworksBuildPhase_list += !frameworksBuildPhase
  buildPhases += !getPBXFileReferenceKey (!seq:[frameworksBuildPhase mSequenceNumber])
#--- Copy build phase in Launch Services
  if inFileToCopyInWrapperLaunchServices != "" then
    @Xcode_PBXFileReference_abstract ref
    [[ioXcodeProjectDescription mFileReferenceMap] searchKey ![inFileToCopyInWrapperLaunchServices nowhere] ?ref]
   #--
    var build_file =@Xcode_PBXBuildFile.new{![ioXcodeProjectDescription mSequenceNumber] !ref}
    ioXcodeProjectDescription.mSequenceNumber ++
    ioXcodeProjectDescription.mAllBuildFileList += !build_file
    var copyBuildPhase =@Xcode_PBXCopyBuildPhase.new{
      ![ioXcodeProjectDescription mSequenceNumber]
      !""
      !1 # Wrapper
      !"Contents/Library/LaunchServices"
      !@Xcode_PBXBuildFile_list. listWithValue {!build_file}
    }
    ioXcodeProjectDescription.mSequenceNumber ++
    ioXcodeProjectDescription.mPBXCopyBuildPhase_list += !copyBuildPhase
    buildPhases += !getPBXFileReferenceKey (!seq:[copyBuildPhase mSequenceNumber])
  end
#--- Define Target Settings
  if inPrecompiledHeaderPath != "" then
    inTargetSettings  += !"GCC_PRECOMPILE_PREFIX_HEADER = YES;"
    inTargetSettings  += !"GCC_PREFIX_HEADER = \"" + inPrecompiledHeaderPath + "\";"
  end
  if inInfoPListFile != "" then
    inTargetSettings += !"INFOPLIST_FILE = \"" +  inInfoPListFile + "\";"
  end
  inTargetSettings += !"GCC_WARN_UNUSED_PARAMETER = NO;"
  inTargetSettings += !"GCC_WARN_PROTOTYPE_CONVERSION = NO;\n"
  inTargetSettings += !"PRODUCT_NAME = \"" + inProductFileName + "\";"
#--- Define dependency data
  var targetDependencyKeyList =@stringlist.emptyList{}
  for () in inDirectDependencyList do
    var d =@Xcode_targetDependencyDescription.new{![ioXcodeProjectDescription mSequenceNumber] !mValue}
    ioXcodeProjectDescription.mSequenceNumber ++
    targetDependencyKeyList += !getPBXFileReferenceKey (!seq:[d mSequenceNumber])
    ioXcodeProjectDescription.mDependencyList += !d
  end
#--- Define Build Configuration
  var toolTargetBuildConfiguration =@Xcode_XCBuildConfiguration.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    ![ioXcodeProjectDescription mSequenceNumber] + 1
    !inTargetSettings
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mBuildConfigurationList += !toolTargetBuildConfiguration
  outTargetKey = [[[[ioXcodeProjectDescription mSequenceNumber] string] md5] rightSubString!24]
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mTargetList +=
    !outTargetKey
    !inTargetName
    !toolTargetBuildConfiguration
    !"$(HOME)/bin"
    !inProductFileName
    !toolFileReference
    !buildPhases
    !targetDependencyKeyList
}

#----------------------------------------------------------------------------------------------------------------------*

proc enterProjectDefaultSettings
  ?let @stringlist inHeaderSearchPathList
  ?let @string inSDK
  !@stringlist outProjectDefaultSettings
  ?let @bool inUsesARC {
#-------------------------------------------------- Define project default configuration
  @string pathString = ""
  for () in inHeaderSearchPathList
  do pathString += "\t\t\t\t\t\"" + mValue + "\",\n"
  end
  outProjectDefaultSettings = @stringlist. emptyList
  outProjectDefaultSettings += !"ALWAYS_SEARCH_USER_PATHS = NO;"
  outProjectDefaultSettings += !"ARCHS = \"$(ARCHS_STANDARD_64_BIT)\";"
  if inUsesARC then
    outProjectDefaultSettings  += !"CLANG_ENABLE_OBJC_ARC = YES;"
  else
    outProjectDefaultSettings  += !"GCC_ENABLE_OBJC_GC = required;"
  end
  outProjectDefaultSettings += !"GCC_GENERATE_DEBUGGING_SYMBOLS = NO;"
  outProjectDefaultSettings += !"GCC_PRECOMPILE_PREFIX_HEADER = YES;"
  outProjectDefaultSettings += !"GCC_THREADSAFE_STATICS = NO;"
  outProjectDefaultSettings += !"GCC_TREAT_IMPLICIT_FUNCTION_DECLARATIONS_AS_ERRORS = YES;"
  outProjectDefaultSettings += !"GCC_TREAT_WARNINGS_AS_ERRORS = YES;"
  outProjectDefaultSettings += !"GCC_WARN_64_TO_32_BIT_CONVERSION = YES;"
  outProjectDefaultSettings += !"GCC_WARN_ABOUT_DEPRECATED_FUNCTIONS = NO;"
  outProjectDefaultSettings += !"GCC_WARN_ABOUT_INVALID_OFFSETOF_MACRO = YES;"
  outProjectDefaultSettings += !"CLANG_WARN_SUSPICIOUS_IMPLICIT_CONVERSION = YES;"
  outProjectDefaultSettings += !"GCC_WARN_ABOUT_MISSING_NEWLINE = YES;"
  outProjectDefaultSettings += !"GCC_WARN_ABOUT_MISSING_PROTOTYPES = YES;"
  outProjectDefaultSettings += !"GCC_WARN_ABOUT_RETURN_TYPE = YES;"
  outProjectDefaultSettings += !"GCC_WARN_CHECK_SWITCH_STATEMENTS = YES;"
  outProjectDefaultSettings += !"GCC_WARN_FOUR_CHARACTER_CONSTANTS = YES;"
  outProjectDefaultSettings += !"GCC_WARN_HIDDEN_VIRTUAL_FUNCTIONS = YES;"
  outProjectDefaultSettings += !"GCC_WARN_INHIBIT_ALL_WARNINGS = NO;"
  outProjectDefaultSettings += !"GCC_WARN_INITIALIZER_NOT_FULLY_BRACKETED = YES;"
  outProjectDefaultSettings += !"GCC_WARN_MISSING_PARENTHESES = YES;"
  outProjectDefaultSettings += !"GCC_WARN_NON_VIRTUAL_DESTRUCTOR = YES;"
  outProjectDefaultSettings += !"GCC_WARN_PEDANTIC = NO;"
  outProjectDefaultSettings += !"GCC_WARN_SHADOW = NO;"
  outProjectDefaultSettings += !"GCC_WARN_SIGN_COMPARE = YES;"
  outProjectDefaultSettings += !"GCC_WARN_TYPECHECK_CALLS_TO_PRINTF = YES;"
  outProjectDefaultSettings += !"GCC_WARN_UNINITIALIZED_AUTOS = YES;"
  outProjectDefaultSettings += !"GCC_WARN_UNKNOWN_PRAGMAS = YES;"
  outProjectDefaultSettings += !"GCC_WARN_UNUSED_FUNCTION = YES;"
  outProjectDefaultSettings += !"GCC_WARN_UNUSED_LABEL = YES;"
  outProjectDefaultSettings += !"GCC_WARN_UNUSED_PARAMETER = YES;"
  outProjectDefaultSettings += !"GCC_WARN_UNUSED_VALUE = YES;"
  outProjectDefaultSettings += !"GCC_WARN_UNUSED_VARIABLE = YES;"
  outProjectDefaultSettings += !"HEADER_SEARCH_PATHS = (\n" + pathString + "\t\t\t\t);"
  outProjectDefaultSettings += !"SDKROOT = " + inSDK + " ;"
}

#----------------------------------------------------------------------------------------------------------------------*

proc buildXcodeProjectString
  ?let @XcodeProjectDescription inXcodeProjectDescription
  ?let @string inProjectName
  ?let @string inMainGroupKey
  ?let @string inProjectDefaultConfigurationKey
  !@string outString {
  @string rootObjectKey = [["project" md5] rightSubString !24]
#--- Header
  outString = "// !$*UTF8*$!\n"
  + "{\n"
  + "\tarchiveVersion = 1;\n"
  + "\tclasses = {\n"
  + "\t};\n"
  + "\tobjectVersion = 42;\n"
  + "\tobjects = {\n\n"
#--- PBXBuildFile section
  for () in [inXcodeProjectDescription mAllBuildFileList]
  before outString += "/* Begin PBXBuildFile section */\n"
  do [mFile buildXcodeProject !?outString]
  after outString += "/* End PBXBuildFile section */\n\n"
  end
#--- PBXFileReference section
  for () in [inXcodeProjectDescription mFileReferenceMap]
  before outString += "/* Begin PBXFileReference section */\n"
  do [mFileReference buildXcodeProject !?outString]
  after outString += "/* End PBXFileReference section */\n"
  end
#--- PBXFrameworksBuildPhase section
  for () in [inXcodeProjectDescription mPBXFrameworksBuildPhase_list]
  before outString += "/* Begin PBXFrameworksBuildPhase section */\n"
  do [mBuildPhase buildXcodeProject !?outString]
  after outString += "/* End PBXFrameworksBuildPhase section */\n"
  end
#--- PBXGroup section
  outString += "/* Begin PBXGroup section */\n"
  for () in [inXcodeProjectDescription mProjectGroupList] do
    outString += "\t\t" + getPBXFileReferenceKey (!seq:[mGroup mSequenceNumber])
    if [mGroup mGroupName] != "" then
      outString += " /* " + [mGroup mGroupName] + " */"
    end
    outString += " = {\n"
    + "\t\t\tisa = PBXGroup;\n"
    + "\t\t\tchildren = (\n"
    for () in [mGroup mChildrenGroupList] do
      outString += "\t\t\t\t" + mRefString + " /* " + mComment + " */,\n"
    end
    outString += "\t\t\t);\n"
    if [mGroup mGroupName] != "" then
      if [[[mGroup mGroupName] componentsSeparatedByString !" "] length] > 1 then
        outString += "\t\t\tname = \"" + [mGroup mGroupName] + "\";\n"
      else
        outString += "\t\t\tname = " + [mGroup mGroupName] + ";\n"
      end
    end
    if [mGroup mGroupPath] != "" then
      outString += "\t\t\tpath = \"" + [mGroup mGroupPath] + "\";\n"
    end
    outString += "\t\t\tsourceTree = \"<group>\";\n"
    + "\t\t};\n"
  end
  outString += "/* End PBXGroup section */\n\n"
#--- PBXNativeTarget section
  for () in [inXcodeProjectDescription mTargetList]
  before outString += "/* Begin PBXNativeTarget section */\n"
  do
    outString += "\t\t" + mTargetKey + " /* " + mTargetName + " */ = {\n"
    + "\t\t\tisa = PBXNativeTarget;\n"
    + "\t\t\tbuildConfigurationList = " + getPBXFileReferenceKey (!seq:[mTargetConfiguration mSequenceNumber2]) + " /* Build configuration list for PBXNativeTarget \"" + mTargetName + "\" */;\n"
    + "\t\t\tbuildPhases = (\n"
    for () in mBuildPhaseKeyList do
      outString += "\t\t\t\t" + mValue + " ,\n"
    end
    @string productExtension [mProduct productExtension ?extension:productExtension] 
    outString += "\t\t\t);\n"
    + "\t\t\tbuildRules = (\n"
    + "\t\t\t);\n"
    + "\t\t\tdependencies = (\n"
    for () in mDependencyKeyList do
      outString += "\t\t\t\t" + mValue + " /*  */,\n"
    end
    outString += "\t\t\t);\n"
    + "\t\t\tname = \"" + mTargetName + "\";\n"
    + "\t\t\tproductInstallPath = \"" + mProductInstallPath + "\";\n"
    + "\t\t\tproductName = \"" + mProductName + "\";\n"
    + "\t\t\tproductReference = " + getPBXFileReferenceKey (!seq:[mProduct mSequenceNumber]) + " ;\n"
    + "\t\t\tproductType = \"com.apple.product-type." + productExtension + "\";\n"
    + "\t\t};\n"
  after outString += "/* End PBXNativeTarget section */\n"
  end
#--- PBXProject section
  outString += "/* Begin PBXProject section */\n"
  + "\t\t" + rootObjectKey + " /* Project object */ = {\n"
  + "\t\t\tisa = PBXProject;\n"
  + "\t\t\tbuildConfigurationList = " + inProjectDefaultConfigurationKey
  + " /* Build configuration list for PBXProject \"" + inProjectName + "\" */;\n"
  + "\t\t\tcompatibilityVersion = \"Xcode 2.4\";\n"
  + "\t\t\thasScannedForEncodings = 1;\n"
  + "\t\t\tmainGroup = " + inMainGroupKey + ";\n"
  + "\t\t\tprojectDirPath = \"\";\n"
  + "\t\t\tprojectRoot = \"\";\n"
  + "\t\t\ttargets = (\n"
  for () in [inXcodeProjectDescription mTargetList] do
    outString += "\t\t\t\t" + mTargetKey + " /* " + mTargetName + " */,\n"
  end
  outString += "\t\t\t);\n"
  + "\t\t};\n"
  + "/* End PBXProject section */\n\n"
#--- PBXResourcesBuildPhase section
  for () in [inXcodeProjectDescription mPBXResourcesBuildPhase_list]
  before outString += "/* Begin PBXResourcesBuildPhase section */\n"
  do
    outString += "\t\t" + getPBXFileReferenceKey (!seq:[mBuildPhase mSequenceNumber])
    + " /* " + [mBuildPhase mNameForComment] + " */ = {\n"
    + "\t\t\tisa = PBXResourcesBuildPhase;\n"
    + "\t\t\tbuildActionMask = 2147483647;\n"
    + "\t\t\tfiles = (\n"
    for () in [mBuildPhase mFileReferenceList] do
      outString += "\t\t\t\t" + getPBXFileReferenceKey (!seq:[mFile mSequenceNumber]) + " ,\n"
    end
    outString +=  "\t\t\t);\n"
    + "\t\t\trunOnlyForDeploymentPostprocessing = 0;\n"
    + "\t\t};\n"
  after outString += "/* End PBXResourcesBuildPhase section */\n"
  end
#--- PBXSourcesBuildPhase section
  for () in [inXcodeProjectDescription mPBXSourcesBuildPhase_list]
  before outString += "/* Begin PBXSourcesBuildPhase section */\n"
  do
    outString += "\t\t" + getPBXFileReferenceKey (!seq:[mBuildPhase mSequenceNumber])
    + " /* " + [mBuildPhase mNameForComment] + " */ = {\n"
    + "\t\t\tisa = PBXSourcesBuildPhase;\n"
    + "\t\t\tbuildActionMask = 2147483647;\n"
    + "\t\t\tfiles = (\n"
    for () in [mBuildPhase mFileReferenceList] do
      outString += "\t\t\t\t" + getPBXFileReferenceKey (!seq:[mFile mSequenceNumber]) + " ,\n"
    end
    outString +=  "\t\t\t);\n"
    + "\t\t\trunOnlyForDeploymentPostprocessing = 0;\n"
    + "\t\t};\n"
  after outString += "/* End PBXSourcesBuildPhase section */\n"
  end
#--- PBXCopyBuildPhase section
  for () in [inXcodeProjectDescription mPBXCopyBuildPhase_list]
  before outString += "/* Begin PBXCopyFilesBuildPhase section */\n"
  do
    outString += "\t\t" + getPBXFileReferenceKey (!seq:[mBuildPhase mSequenceNumber])
    + " /* Copy Files */ = {\n"
    + "\t\t\tisa = PBXCopyFilesBuildPhase;\n"
    + "\t\t\tbuildActionMask = 2147483647;\n"
    + "\t\t\tdstPath = \"" + [mBuildPhase mDestinationPath] + "\";\n"
    + "\t\t\tdstSubfolderSpec = " + [mBuildPhase mDestinationSubfolder] + ";\n"
    + "\t\t\tfiles = (\n"
    for () in [mBuildPhase mFileReferenceList] do
      outString += "\t\t\t\t" + getPBXFileReferenceKey (!seq:[mFile mSequenceNumber]) + " ,\n"
    end
    outString +=  "\t\t\t);\n"
    + "\t\t\trunOnlyForDeploymentPostprocessing = 0;\n"
    + "\t\t};\n"
  after outString += "/* End PBXCopyFilesBuildPhase section */\n"
  end
#--- PBXTargetDependency section
  for () in [inXcodeProjectDescription mDependencyList]
  before outString += "/* Begin PBXTargetDependency section */\n"
  do
    outString += "\t\t" + getPBXFileReferenceKey (!seq:[mDependency mSequenceNumber])
    + " /* PBXTargetDependency */ = {\n"
    + "\t\t\tisa = PBXTargetDependency;\n"
    + "\t\t\ttarget = " + [mDependency mDependencyTarget] + " ;\n"
    + "\t\t};\n"
  after outString += "/* End PBXTargetDependency section */\n"
  end
#--- PBXVariantGroup section
  for () in [inXcodeProjectDescription mPBXVariantGroup_list]
  before outString += "/* Begin PBXVariantGroup section */\n"
  do
    outString += "\t\t" + mPBXVariantKey
    + " /* " + mName + " */ = {\n"
    + "\t\t\tisa = PBXVariantGroup;\n"
    + "\t\t\tchildren = (\n"
    + "\t\t\t\t" + mPBXFileReferenceKey + " ,\n"
    + "\t\t\t);\n"
    + "\t\t\tname = " + mName + ";\n"
    + "\t\t\tsourceTree = \"<group>\";\n"
    + "\t\t};\n"
  after outString += "/* End PBXVariantGroup section */\n"
  end
#--- XCBuildConfiguration section
  for () in [inXcodeProjectDescription mBuildConfigurationList]
  before outString += "/* Begin XCBuildConfiguration section */\n"
  do
    outString += "\t\t" + getPBXFileReferenceKey (!seq:[mBuildConfig mSequenceNumber1]) + " /* Default */ = {\n"
    + "\t\t\tisa = XCBuildConfiguration;\n"
    + "\t\t\tbuildSettings = {\n"
    for () in [mBuildConfig mSettings] do
      outString += "\t\t\t\t" + mValue + "\n"
    end
    outString +=  "\t\t\t};\n"
    + "\t\t\tname = Default;\n"
    + "\t\t};\n"
  after outString += "/* End XCBuildConfiguration section */\n\n"
  end
#--- XCConfigurationList section
  for () in [inXcodeProjectDescription mBuildConfigurationList]
  before outString += "/* Begin XCConfigurationList section */\n"
  do
    outString += "\t\t" + getPBXFileReferenceKey (!seq:[mBuildConfig mSequenceNumber2]) + " /* Build configuration list for PBXProject \""
    + inProjectName + "\" */ = {\n"
    + "\t\t\tisa = XCConfigurationList;\n"
    + "\t\t\tbuildConfigurations = (\n"
    + "\t\t\t\t" + getPBXFileReferenceKey (!seq:[mBuildConfig mSequenceNumber1]) + " /* Default */,\n"
    + "\t\t\t);\n"
    + "\t\t\tdefaultConfigurationIsVisible = 0;\n"
    + "\t\t\tdefaultConfigurationName = Default;\n"
    + "\t\t};\n"
  after outString += "/* End XCConfigurationList section */\n"
  end
#--- 
  outString += "\t};\n"
  + "\trootObject = " + rootObjectKey + " /* Project object */;\n"
  + "}\n"
}

#----------------------------------------------------------------------------------------------------------------------*

proc generateXCodeFile
  ?!@XcodeProjectDescription ioXcodeProjectDescription
  ?let @string in_xcodeproj_filePath
  ?let @stringlist inProjectDefaultSettings
  ?let @string inReferenceFilePath {
  @string projectName = [[in_xcodeproj_filePath lastPathComponent] stringByDeletingPathExtension]

  var defaultProjectConfiguration =@Xcode_XCBuildConfiguration.new{
    ![ioXcodeProjectDescription mSequenceNumber]
    ![ioXcodeProjectDescription mSequenceNumber] + 1
    !inProjectDefaultSettings
  }
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mBuildConfigurationList += !defaultProjectConfiguration
#--- "Products" Group
  enter_group (
    !?ioXcodeProjectDescription
    !"Products"
    !""
    ![ioXcodeProjectDescription mProductGroupChildrenList]
  )
#--- Main Group
  var mainGroup =@Xcode_PBXGroup.new{![ioXcodeProjectDescription mSequenceNumber] !"" !"" ![ioXcodeProjectDescription mMainGroupChildrenList]}
  ioXcodeProjectDescription.mSequenceNumber ++
  ioXcodeProjectDescription.mProjectGroupList += !mainGroup
#--- Build Project contents string
  @string fileNewContents
  buildXcodeProjectString (
    !ioXcodeProjectDescription
    !projectName
    !getPBXFileReferenceKey (!seq:[mainGroup mSequenceNumber])
    !getPBXFileReferenceKey (!seq:[defaultProjectConfiguration mSequenceNumber2])
    ?fileNewContents
  )
  if @uint. errorCount == 0 then
  #--- Create .xcodeproj directory (if does not exist)
    [in_xcodeproj_filePath makeDirectory]
  #--- Update (or create) Xcode project file
    @bool written
    [fileNewContents writeToFileWhenDifferentContents !inReferenceFilePath ?written]
    let @string pbxprojFilePath = in_xcodeproj_filePath + "/project.pbxproj"
    if written | not [pbxprojFilePath fileExists] then
      [fileNewContents writeToFileWhenDifferentContents !pbxprojFilePath ?*]
  #--- Delete all XXX.pbxuser files in this directory
      @stringlist pbxuser_files = [in_xcodeproj_filePath regularFilesWithExtensions !false !@stringlist. listWithValue {!"pbxuser"}]
      for () in pbxuser_files do
        @string fullPath = in_xcodeproj_filePath + "/" + mValue
        [@string deleteFile !fullPath]
      end
    end
  end
}

#----------------------------------------------------------------------------------------------------------------------*

