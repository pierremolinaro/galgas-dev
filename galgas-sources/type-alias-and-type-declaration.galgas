#———————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
#   SYNTAX                                  
#———————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

syntax extension galgas3DeclarationsSyntax {

  #·····················································································································
  
  rule <declaration> ?!@galgasDeclarationAST ioDeclarations {
    $typealias$
    $@type$ ?let aliasTypeName indexing dictionaryDefinition
    $=$
    <type_definition> !?ioDeclarations ?let @lstring definedTypeName
    ioDeclarations.mDeclarationList += !@typealiasDeclarationAST.new {
      !false # Is not predefined
      !aliasTypeName
      !definedTypeName
    }
  }
  
  #·····················································································································
  # SIMPLE ALIAS
  #·····················································································································
  
  rule <type_definition> ?!@galgasDeclarationAST unused ioDeclarations
                         !@lstring outTypeName {
    $@type$ ?outTypeName
  }

  #·····················································································································

}

#———————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

syntax extension galgas4DeclarationsSyntax {

   #·····················································································································
  
  rule <declaration> ?!@galgasDeclarationAST ioDeclarations {
    $typealias$
    $@type$ ?let aliasTypeName indexing dictionaryDefinition
    $=$
    <type_definition> !?ioDeclarations ?let @lstring definedTypeName
    ioDeclarations.mDeclarationList += !@typealiasDeclarationAST.new {
      !false # Is not predefined
      !aliasTypeName
      !definedTypeName
    }
  }
  
  #·····················································································································
  # SIMPLE ALIAS
  #·····················································································································
  
  rule <type_definition> ?!@galgasDeclarationAST unused ioDeclarations
                         !@lstring outTypeName {
    $@type$ ?outTypeName
  }

  #·····················································································································

}

#———————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
#   AST                                     
#———————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

refclass @typealiasDeclarationAST : @semanticDeclarationAST {
  private let @lstring mAliasTypeName
  private let @lstring mDefinedTypeName

  #·····················································································································

  override getter keyRepresentation -> @string {
    result = "typealias @" + self.mAliasTypeName
  }

  #·····················································································································

  override method addAssociatedElement ?!@semanticDeclarationListAST unused ioSemanticDeclarationList {
  }

  #·····················································································································

  override method enterDeclarationInGraph
                                  ?!@semanticTypePrecedenceGraph ioSemanticTypePrecedenceGraph
                                  ?!@extensionMethodMapForBuildingContext unused ioExtensionMethodMapForBuildingContext
                                  ?!@extensionGetterMapForBuildingContext unused ioExtensionGetterMapForBuildingContext
                                  ?!@extensionSetterMapForBuildingContext unused ioExtensionSetterMapForBuildingContext
                                  ?!@semanticDeclarationListAST unused ioExtensionOverrideDefinitionList {
    let aliasKey = @lstring.new {!"@" + self.mAliasTypeName !self.mAliasTypeName.location}
    [!?ioSemanticTypePrecedenceGraph addNode !aliasKey !self]
    let referenceKey = @lstring.new {!"@" + self.mDefinedTypeName !self.mDefinedTypeName.location}
    [!?ioSemanticTypePrecedenceGraph noteNode !referenceKey]
    [!?ioSemanticTypePrecedenceGraph addEdge !aliasKey !referenceKey]
  }

  #·····················································································································

  override method enterDeclarationInSemanticContext
                              ?let @extensionMethodMapForBuildingContext unused inExtensionMethodMapForBuildingContext
                              ?let @extensionGetterMapForBuildingContext unused inExtensionGetterMapForBuildingContext
                              ?let @extensionSetterMapForBuildingContext unused inExtensionSetterMapForBuildingContext
                              ?!@unifiedTypeMap ioTypeMap
                              ?!@semanticContext unused ioSemanticContext {
    [!?ioTypeMap makeEntryFromString !self.mDefinedTypeName ?let definedTypeEntry]
    switch definedTypeEntry
    case null :
      error self.mDefinedTypeName : "Undefined type"
    case element (@unifiedTypeMapElementClass-weak weakElement) :
      switch weakElement.bang.mDefinition
      case unsolved :
        error self.mDefinedTypeName : "Undefined type"
      case solved (@unifiedTypeDefinition definition) :
        [!?ioTypeMap insertType !self.mAliasTypeName !definition]
      end
    end
  }

  #·····················································································································

  override method semanticAnalysis  ?!@lstringlist unused ioUsefulnessRootEntities 
                                    ?!@usefulEntitiesGraph ioUsefulEntitiesGraph
                                    ?let @string unused inProductDirectory
                                    ?let @semanticContext unused inSemanticContext
                                    ?!@unifiedTypeMap unused ioTypeMap
                                    ?let @predefinedTypes unused inPredefinedTypes
                                    ?!@semanticDeclarationListForGeneration unused ioSemanticDeclarationListForGeneration  {
  #--- Useful entities graph
    let nameForUsefulness = typeNameForUsefulEntitiesGraph (!self.mAliasTypeName)
    [!?ioUsefulEntitiesGraph addNode !nameForUsefulness !nameForUsefulness]
    let elementTypeNameForUsefulness = typeNameForUsefulEntitiesGraph (!self.mDefinedTypeName)
    [!?ioUsefulEntitiesGraph addEdge !nameForUsefulness !elementTypeNameForUsefulness]
  }

  #·····················································································································

}
 
#———————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
